{% extends 'base.html' %}
{% block title %}Tableau de bord - Kardex Hôtel Social{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-12 col-xl-4 d-flex flex-column">
    <div class="card shadow-soft p-3">
      <div class="d-flex align-items-center">
        <div class="display-6 me-3 text-info"><i class="bi bi-people-fill"></i></div>
        <div>
          <div class="text-secondary text-uppercase small">Total clients</div>
          <div class="h3 m-0">{{ total_clients }}</div>
          <div class="small text-secondary">
            Adultes : {{ adult_female_count }} femmes, {{ adult_male_count }} hommes<br>
            Enfants : {{ girl_count }} filles, {{ boy_count }} garçons
          </div>
        </div>
      </div>
    </div>
    <div class="card shadow-soft p-3 mt-4">
      <h6 class="mb-3"><i class="bi bi-cake2 me-2"></i>Anniversaires</h6>
      {% if birthdays_today %}
      <div class="alert alert-warning py-2 mb-3 small">
        Joyeux anniversaire à
        {% for b in birthdays_today %}
          <strong>{{ b.person.first_name }} {{ b.person.last_name }}</strong> ({{ b.age }} ans){% if not loop.last %}{% if loop.revindex == 2 %} et {% else %}, {% endif %}{% endif %}
        {% endfor %} !
      </div>
      {% endif %}
      <ul class="nav nav-tabs small" id="birthdayTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="weekahead-tab" data-bs-toggle="tab" data-bs-target="#weekahead" type="button" role="tab">Semaine à venir</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="weekpast-tab" data-bs-toggle="tab" data-bs-target="#weekpast" type="button" role="tab">Semaine passée</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="monthahead-tab" data-bs-toggle="tab" data-bs-target="#monthahead" type="button" role="tab">Mois à venir</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="monthpast-tab" data-bs-toggle="tab" data-bs-target="#monthpast" type="button" role="tab">Mois passé</button>
        </li>
      </ul>
      <div class="tab-content small mt-3">
        <div class="tab-pane fade show active" id="weekahead" role="tabpanel">
          <ul class="list-group list-group-flush">
            {% for b in birthdays_week_ahead %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ fmt_date(b.date) }} — {{ b.person.first_name }} {{ b.person.last_name }}</span>
                <span class="badge text-bg-primary rounded-pill">{{ b.age }} ans</span>
              </li>
            {% else %}
              <li class="list-group-item">Aucun</li>
            {% endfor %}
          </ul>
        </div>
        <div class="tab-pane fade" id="weekpast" role="tabpanel">
          <ul class="list-group list-group-flush">
            {% for b in birthdays_week_past %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ fmt_date(b.date) }} — {{ b.person.first_name }} {{ b.person.last_name }}</span>
                <span class="badge text-bg-secondary rounded-pill">{{ b.age }} ans</span>
              </li>
            {% else %}
              <li class="list-group-item">Aucun</li>
            {% endfor %}
          </ul>
        </div>
        <div class="tab-pane fade" id="monthahead" role="tabpanel">
          <ul class="list-group list-group-flush">
            {% for b in birthdays_month_ahead %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ fmt_date(b.date) }} — {{ b.person.first_name }} {{ b.person.last_name }}</span>
                <span class="badge text-bg-primary rounded-pill">{{ b.age }} ans</span>
              </li>
            {% else %}
              <li class="list-group-item">Aucun</li>
            {% endfor %}
          </ul>
        </div>
        <div class="tab-pane fade" id="monthpast" role="tabpanel">
          <ul class="list-group list-group-flush">
            {% for b in birthdays_month_past %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ fmt_date(b.date) }} — {{ b.person.first_name }} {{ b.person.last_name }}</span>
                <span class="badge text-bg-secondary rounded-pill">{{ b.age }} ans</span>
              </li>
            {% else %}
              <li class="list-group-item">Aucun</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-xl-4">
    <div class="card shadow-soft p-3">
      <h6 class="mb-3"><i class="bi bi-gender-ambiguous me-2"></i>Répartition par sexe</h6>
      <canvas id="sexChart" height="200"></canvas>
    </div>
    <div class="card shadow-soft p-3 mt-4">
      <h6 class="mb-3"><i class="bi bi-hourglass-split me-2"></i>Ancienneté</h6>
      <ul class="nav nav-pills mb-3" id="seniorityTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="old-tab" data-bs-toggle="pill" data-bs-target="#old-fam" type="button" role="tab">Plus anciennes</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="new-tab" data-bs-toggle="pill" data-bs-target="#new-fam" type="button" role="tab">Plus récentes</button>
        </li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="old-fam" role="tabpanel">
          <canvas id="oldFamiliesChart" height="200"></canvas>
        </div>
        <div class="tab-pane fade" id="new-fam" role="tabpanel">
          <canvas id="newFamiliesChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-xl-4">
    <div class="card shadow-soft p-3">
      <h6 class="mb-3"><i class="bi bi-activity me-2"></i>Tranches d’âge</h6>
      <canvas id="ageChart" height="200"></canvas>
      <div class="d-flex align-items-center justify-content-center gap-3 mt-2">
        <div class="d-flex align-items-center">
          <span class="me-1" style="width:12px;height:12px;background-color:{{ age_colors_f[0] }};display:inline-block;border-radius:2px;"></span>
          <span class="small">Femmes</span>
        </div>
        <div class="d-flex align-items-center">
          <span class="me-1" style="width:12px;height:12px;background-color:{{ age_colors_m[0] }};display:inline-block;border-radius:2px;"></span>
          <span class="small">Hommes</span>
        </div>
      </div>
      <div id="ageLegend" class="mt-2 d-flex flex-column align-items-center">
        {% for lbl in age_labels %}
        <div class="d-flex align-items-center justify-content-center mb-1">
          <span class="me-1" style="width:12px;height:12px;background-color:{{ age_colors_f[loop.index0] }};display:inline-block;border-radius:2px;"></span>
          <span class="me-2" style="width:12px;height:12px;background-color:{{ age_colors_m[loop.index0] }};display:inline-block;border-radius:2px;"></span>
          <span class="small">{{ lbl }}</span>
        </div>
      {% endfor %}
      </div>
    </div>
    <div class="card shadow-soft p-3 mt-4">
      <h6 class="mb-3"><i class="bi bi-exclamation-triangle me-2"></i>Alertes</h6>
      <div class="d-flex flex-column gap-3">
        <div class="alert alert-danger d-flex align-items-start mb-0" role="alert">
          <i class="bi bi-people-fill fs-4 me-2"></i>
          <div>
            <div class="fw-bold">Familles &gt;3 pers. dans une chambre (hors 53/54)</div>
            <ul class="mb-0 ps-3">
              {% for f in overcrowded_families %}
                <li class="small">{{ f.label or "Famille " ~ f.id }} — chambre {{ rooms_text(f) }} ({{ f.persons.count() }} pers.)</li>
              {% else %}
                <li class="small">Aucune</li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="alert alert-warning d-flex align-items-start mb-0" role="alert">
          <i class="bi bi-person-exclamation fs-4 me-2"></i>
          <div>
            <div class="fw-bold">Femmes isolées</div>
            <ul class="mb-0 ps-3">
              {% for f in isolated_women_families %}
                <li class="small">{{ f.label or "Famille " ~ f.id }} — chambre {{ rooms_text(f) }}</li>
              {% else %}
                <li class="small">Aucune</li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="alert alert-info d-flex align-items-start mb-0" role="alert">
          <i class="bi bi-baby fs-4 me-2"></i>
          <div>
            <div class="fw-bold">Bébés de moins d'un an</div>
            <ul class="mb-0 ps-3">
              {% for f in baby_families %}
                <li class="small">{{ f.label or "Famille " ~ f.id }} — chambre {{ rooms_text(f) }}</li>
              {% else %}
                <li class="small">Aucune</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-soft p-3 mt-4">
  <div class="d-flex align-items-center justify-content-between">
    <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Familles récentes</h6>
    <span class="badge rounded-pill badge-soft">{{ families|length }} familles</span>
  </div>
  <div class="table-responsive mt-3" style="max-height: 420px;">
    <table id="familiesTable" class="table table-striped table-hover align-middle table-sm">
      <thead>
        <tr><th>#</th><th>Famille</th><th>Chambre</th><th>Arrivée</th><th>Personnes</th><th data-orderable="false"></th></tr>
      </thead>
      <tbody>
      {% for f in families %}
        <tr>
          <td class="text-secondary">{{ f.id }}</td>
          <td class="fw-semibold">{{ f.label or "—" }}</td>
          <td data-order="{{ (rooms_text(f) or 0)|int }}">{{ rooms_text(f) or '' }}</td>
          <td data-order="{{ f.arrival_date.strftime('%Y-%m-%d') if f.arrival_date }}">
            {{ f.arrival_date.strftime('%d/%m/%Y') if f.arrival_date }}
          </td>
          <td><span class="badge text-bg-secondary">{{ f.persons.count() }}</span></td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-info" href="{{ url_for('persons_list', fid=f.id) }}"><i class="bi bi-arrow-right-circle"></i></a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  if (window.ChartDataLabels) {
    Chart.register(ChartDataLabels);
  }

  window.activeCharts = [];
  window.activeCharts.push(new Chart(document.getElementById('sexChart'), {
    type: 'doughnut',
    data: {
      labels: {{ sex_labels|tojson }},
      datasets: [
        {
          data: {{ sex_values|tojson }},
          backgroundColor: ['#e83e8c', '#007bff', '#6c757d']
        },
        {
          data: {{ sex_child_values|tojson }},
          backgroundColor: ['#f8a5c2', '#66b2ff', '#adb5bd'],
          weight: 0.5
        }
      ]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
          formatter: (v, ctx) => ctx.datasetIndex === 0 ? (v || '') : '',
          font: { weight: 600 }
        }
      },
      cutout: '60%'
    }
  }));

  const oldTenures = {{ old_tenures|tojson }};
  window.activeCharts.push(new Chart(document.getElementById('oldFamiliesChart'), {
    type: 'bar',
    data: {
      labels: {{ old_labels|tojson }},
      datasets: [{
        data: {{ old_values|tojson }},
        backgroundColor: '#6f42c1'
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        datalabels: { anchor: 'end', align: 'right', formatter: (_, ctx) => oldTenures[ctx.dataIndex] }
      },
      scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  }));

  const recentTenures = {{ recent_tenures|tojson }};
  window.activeCharts.push(new Chart(document.getElementById('newFamiliesChart'), {
    type: 'bar',
    data: {
      labels: {{ recent_labels|tojson }},
      datasets: [{
        data: {{ recent_values|tojson }},
        backgroundColor: '#198754'
      }]
    },
    options: {
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        datalabels: { anchor: 'end', align: 'right', formatter: (_, ctx) => recentTenures[ctx.dataIndex] }
      },
      scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  }));

  const ageColorsF = {{ age_colors_f|tojson }};
  const ageColorsM = {{ age_colors_m|tojson }};
  window.activeCharts.push(new Chart(document.getElementById('ageChart'), {
    type: 'bar',
    data: {
      labels: {{ age_labels|tojson }},
      datasets: [
        {
          label: 'Femmes',
          data: {{ age_f_values|tojson }},
          backgroundColor: ageColorsF
        },
        {
          label: 'Hommes',
          data: {{ age_m_values|tojson }},
          backgroundColor: ageColorsM
        }
      ]
    },
    options: {
      plugins: {
        legend: { display: false },
        datalabels: { anchor: 'end', align: 'top', formatter: v => v || '' }
      },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  }));

});
</script>
{% endblock %}
